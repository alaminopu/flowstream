<script total>

	const CONFIDENCE = { 0: 'Failed', 1: 'Low', 2: 'Medium', 3: 'High' };
	const BATTERY = { 0: 'Uninitialized', 1: 'Calculating', 2: 'Initialized', 3: 'Failsafe LOW', 4: 'Failsafe CRT', 255: 'Error' };
	const STATE = {
		0: 'Starting UP',
		1: 'Ready',
		2: 'Booting',
		3: 'Boot complete',
		4: 'Taking off',
		5: 'Take off complete',
		6: 'Searching aruco',
		7: 'Flight ready',
		8: 'Targeting',
		9: 'Homing',
		10: 'Landing',
		11: 'Error'
	};

	exports.name = 'ROS Broker';
	exports.icon = 'fal fa-handshake';
	exports.config = {};
	exports.inputs = [{ id: 'message', name: 'Message' }];
	exports.outputs = [{ id: 'state', name: 'State' }, { id: 'confidence', name: 'Confidence' }, { id: 'battery', name: 'Battery' }, { id: 'camera', name: 'Camera' }, { id: 'position', name: 'Position' }];

	exports.make = function(instance) {

		var prev;
		var model = {};
		// var count = 0;

		var makecompare = function(val) {

			if (typeof(val) !== 'object')
				return val + ',';

			if (val == null)
				return 'null,';

			var keys = Object.keys(val);
			var val = '';
			for (var i = 0; i < keys.length; i++)
				val += val[keys[i]] + ',';
		};

		instance.message = function($) {

			var data = $.data;
			var tmp;

			switch (data.topic) {
				case '/ae_drone_control/global_position/local':
					model.position = data.msg.pose.position;
					model.orientation = data.msg.pose.orientation;

					tmp = makecompare(model.position) + makecompare(model.orientation);

					if (TEMP[data.topic] === tmp)
						return;

					TEMP[data.topic] = tmp;
					$.send('position', { position: model.position, orientation: model.orientation });
					break;

				case '/ae_drone_control/drone/state':

					tmp = data.msg.state;

					if (TEMP[data.topic] === tmp)
						return;

					TEMP[data.topic] = tmp;
					model.state = { id: data.msg.state, name: STATE[data.msg.state] };
					$.send('state', model.state);
					break;

				case '/ae_drone_control/t265/confidence':

					tmp = makecompare(data.msg.data);

					if (TEMP[data.topic] === tmp)
						return;

					TEMP[data.topic] = tmp;

					model.confidence = { id: data.msg.data, name: CONFIDENCE[data.msg.data] };
					$.send('confidence', model.confidence);
					break;

				case '/ae_drone_control/battery/state':

					tmp = makecompare(data.data);
					if (TEMP[data.topic] === tmp)
						return;

					TEMP[data.topic] = tmp;

					model.battery = data.msg;
					model.battery.statename = BATTERY[data.msg.state];
					$.send('battery', model.battery);
					break;

				case '/ae_drone_control/qr/detected':
					// model.qrdetected.shi
					console.log('QR Detected', data.msg);
					break;

				case '/ae_drone_control/qr/color/compressed':
					tmp = makecompare(data.msg.data);

					if (TEMP[data.topic] === tmp)
						return;

					TEMP[data.topic] = tmp;
					model.camera = data.msg.data;
					$.send('camera', model.camera);
					break;
			}

			// console.log(count++);
			$.status(model);
			$.dashboard(model);
		};

	};

</script>

<settings>
	SETTINGS
</settings>

<style>
	.fbroker { margin-top: 5px; width: 440px; }
	.fbroker .item-container { width: 220px; float: left; border-left: 1px solid #E0E0E0; padding: 0 5px; }
	.fbroker .item-container:first-child { border-left: 0; padding-left: 0; }
	.fbroker .item { line-height: 24px; font-size: 11px; border-bottom: 1px solid #E0E0E0; }
	.fbroker .item i { margin-right: 5px; }
	.fbroker::after, .fbroker .item::after { content: ""; clear: both; display: table; }
	.fbroker .item:last-child { border-bottom: 0; }
	.fbroker .item .key { float: left; width: 50%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
	.fbroker .item .value { float: left; width: 50%; padding: 0 0 0 5px; border-left: 1px solid #E0E0E0; }
</style>

<body>
	<div><i class="fal fa-handshake mr5"></i>ROS Broker</div>
	<div class="fbroker" data-bind="?.status.{0}__template">
		<script type="text/html">
		<div class="item-container">
			<div class="item">
				<div class="key"><i class="fal fa-drone-alt"></i>State</div>
				<div class="value">{{ value.state.name | def }} ({{ value.state.id | def }})</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-crosshairs"></i>Position: X</div>
				<div class="value">{{ value.position.x | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-crosshairs"></i>Position: Y</div>
				<div class="value">{{ value.position.y | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-crosshairs"></i>Position: Z</div>
				<div class="value">{{ value.position.z | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-crosshairs"></i>Position: W</div>
				<div class="value">{{ value.position.w | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-compass"></i>Orientation: X</div>
				<div class="value">{{ value.orientation.x | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-compass"></i>Orientation: Y</div>
				<div class="value">{{ value.orientation.y | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-compass"></i>Orientation: Z</div>
				<div class="value">{{ value.orientation.z | format(3) | def }}</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-compass"></i>Orientation: W</div>
				<div class="value">{{ value.orientation.w | format(3) | def }}</div>
			</div>
		</div>
		<div class="item-container">
			<div class="item">
				<div class="key"><i class="fal fa-camera-alt"></i>Confidence</div>
				<div class="value">{{ value.confidence.name | def }} ({{ value.confidence.id | def }})</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>State</div>
				<div class="value">{{ value.battery.statename | def }} ({{ value.battery.state | def }})</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Percentage</div>
				<div class="value">{{ value.battery.percentage | format(2) | def }} %</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Voltage</div>
				<div class="value">{{ value.battery.voltage | format(2) | def }} V</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Min. Voltage</div>
				<div class="value">{{ value.battery.voltage | format(2) | def }} V</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Charge</div>
				<div class="value">{{ value.battery.charge | format(2) | def }} mAh</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Capacity</div>
				<div class="value">{{ value.battery.capacity | format(2) | def }} mAh</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Design capacity</div>
				<div class="value">{{ value.battery.design_capacity | format(2) | def }} mAh</div>
			</div>
			<div class="item">
				<div class="key"><i class="fal fa-battery-bolt"></i>Consumption</div>
				<div class="value">{{ value.battery.current | format(2) | def }} A</div>
			</div>
		</div>
		</script>
	</div>
</body>