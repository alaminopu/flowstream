<script total>

	exports.name = 'ROS';
	exports.icon = 'far fa-microchip';
	exports.config = {};
	exports.outputs = [{ id: 'online', name: '<i class="fa fa-circle green mr5"></i>Online' }, { id: 'offline', name: '<i class="fa fa-circle red mr5"></i>Offline' }];

	exports.make = function(instance, config) {

		var prevstate;

		var onmessage = function(msg) {
			instance.send('online', msg);
		};

		var onsocket = function() {
			var online = !!ROS.ws;

			console.log('--->', online);

			if (prevstate !== online) {
				prevstate = online;
				instance.status(online);
				if (!online)
					instance.send('offline');
			}

			if (ROS.ws) {
				if (online)
					ROS.ws.on('message', onmessage);
				else
					ROS.ws.removeListener('message', onmessage);
			}
		};

		ON('ros_socket', onsocket);
		setTimeout(onsocket, 100);

		instance.close = function() {
			ROS.ws && ROS.ws.removeListener('message', onmessage);
			OFF('ros_socket', onsocket);
		};

		instance.configure = function() {
			console.log('SOM TU', config);
		};

	};

</script>

<settings>
	<div class="padding">
		<div data---="input__?.name">Name</div>
	</div>
</settings>

<style>
	.fros { font-size: 12px; color: gray; }
	.fros span { font-weight: bold; }
</style>

<body>
	<div><i class="far fa-microchip mr5"></i>ROS</div>
	<div data-bind="?.status.{0}__template__exec:frosstatus" class="fros">
		<template>
			Current state: {{ if value }}<span class="green"><i class="fa fa-refresh fa-spin"></i> Online</span>{{ else }}<span class="red"><i class="fa fa-exclamation-circle"></i> Offline</span>{{ fi }}
		</template>
	</div>
</body>

<script>
	W.frosstatus = function(value, path, el) {
		el.closest('.component').css('border-color', value ? '#83C83C' : '#E73323');
	};
</script>